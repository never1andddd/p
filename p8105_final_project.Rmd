---
title: "p8105_final_project"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(rvest)
library(httr)
library(tidyverse)
library(rjson)
library(tidyr)
library(readr)
library(dplyr)
library(jsonlite)
library(stringr)
library(forcats)
library(viridis)
library(tidytext)
library(janitor)
## Loading required package: viridisLite

library(plotly)
```

# Getting Data of Restaurant in business.json
```{r}
business <- stream_in(file("../data/business.json"))


# specificly we are only interested in the covariate price in the attributes
price = select(business$attributes,RestaurantsPriceRange2)

business_no_attri = select(business,-attributes,-hours)

business.dat = bind_cols(business_no_attri,price)

# for simplicity, we focus on restaurants in state of Arizona(AZ)
rest.dat = business.dat %>%
  mutate(categories = as.character(categories)) %>%
  filter(str_detect(categories, "Restaurants")) %>%
  filter(state == "AZ") 

# review <- stream_in(file("../data/review.json"))
```

# explore the categories of restaurants
## a rough preview of data
```{r}
cate.dat = rest.dat %>%
  mutate(categories = str_replace(categories,"c\\(","")) %>%
  unnest_tokens(category, categories) %>%
  select(-neighborhood)

# get an overview of categories
cate.dat %>%
  count(category, sort = TRUE) %>%
  top_n(50)%>%
  mutate(category = fct_reorder(category, n)) %>% 
  ggplot(aes(x = category, y = n)) + 
  geom_bar(stat = "identity", fill = "blue", alpha = .6) + 
  coord_flip()
```
 We notice that:
 1. 'Restaurants', 'food', 'sports' gives no further information of what a restaurant serves. Therefore, we need to remove them.  
 2. Category 'american new' and 'american traditional' are devided into 3 categories namely 'american',
'new' and 'traditional'. This is redundant and we need to remove 'american' from this dataset.  
 3. Category 'chicken wings' is devided into 2 categories namely 'chicken' and 'wings'. This is redundant and we need to remove 'chicken' from this dataset. This is same for 'breakfast & brunch' and 'coffee & tea'. We will remove 'brunch' and 'tea' for simplicity.
 4. Category 'bar' and 'nightlife' are somewhat overlaid. Therefore, we remove 'night life'.  
 5. Category 'Event Planning & Services' is devided into 3 categories namely 'event', 'planning' and 'services'. These categories gives no further information of what a restaurant serves. Therefore, we need to remove them.  
 6. 'Bars','fast food' do not give further information of what a restaurant serves and cause a restaurant to have multiple categories, hence are removed. 

## data clean of category
```{r}
category <- c('restaurants','food','american','chicken','nightlife','services','planning','event','sports','brunch','tea','bars','fast')
stop_cates = data.frame(category) %>%
  mutate(category = as.character(category))

cate.dat = 
  anti_join(cate.dat, stop_cates)
  
categories = cate.dat %>%
  count(category, sort = TRUE) %>%
# omit categories with few restaurants, this is a trade-off because we might lose some restaurant, but we will get rid of some noise too
  top_n(10)

# get an overview of categories
categories %>%
  mutate(category = fct_reorder(category, n)) %>% 
  ggplot(aes(x = category, y = n)) + 
  geom_bar(stat = "identity", fill = "blue", alpha = .6) + 
  coord_flip()


# there are some variables that seem to make no sense like 'fast', 'traditional' and 'new'. explanation: 
final.dat = inner_join(categories,cate.dat) 
final.dat %>%
  unique() %>%
  distinct(business_id)

# from this table we find there are many restaurants with multiple categories
# write a loop to assign each restaurant a categorie that is of highest frequency?

```

# a map of restaurant 
```{r}
final.dat %>%
  mutate(text_label = str_c('Name:',name,"\nPostal code: ", postal_code, '\nAddress: ', address, '\nCategory: ', category)) %>% 
  plot_ly(x = ~longitude, y = ~latitude, type = "scatter", mode = "markers",
          alpha = 0.5, 
          color = ~category,
          text = ~text_label)

```

```{r}
# Weâ€™re going to show only 10 categories with the most restaurants
common_category =
  final.dat %>% 
  count(category, sort = TRUE) %>% 
  top_n(10) %>% 
  select(category)
## Selecting by n

inner_join(final.dat, common_category,
             by = "category") %>% 
  mutate(category = fct_reorder(category, review_count)) %>% 
  plot_ly(y = ~review_count, color = ~category, type = "box",
          colors = "Set2")

```

```{r}
final.dat %>% 
  mutate(category = fct_reorder(category, n)) %>% 
  plot_ly(x = ~category, y = ~n, color = ~category, type = "bar")
```

```{r}
inner_join(final.dat, common_category,
             by = "category") %>% 
  mutate(category = fct_reorder(category, n)) %>% 
  plot_ly(x = ~category, y = ~n, color = ~category, type = "bar")

```

```{r bubble plot}
#A grid of detailed average ratings by categories
#Basically, the average review rating scores in each state was reclassified from 1.0 to 5.0 by 0.5 increase. For visualization purpose, percentage of rating score is weighted.
dataWeighted_catestar <- final.dat %>% 
  group_by(category,stars) %>%
  summarise(totalByStar = n()) %>% arrange(desc(stars)) %>% 
  mutate(total = sum(totalByStar)) %>% mutate(percent = round((totalByStar / total)*100, 1)) %>%
  mutate(percentWeight = ifelse(percent >= 20, percent * 1.5, # custom column to weight the percent for size on the plot
                                ifelse(percent < 20 & percent >= 15, percent * 1, 
                                       ifelse(percent < 15 & percent >= 10, percent,
                                              ifelse(percent < 10 & percent >= 5, percent * 0.6, 1)))))


  library(ggplot2)
ggplot(dataWeighted_catestar, aes(x = category, y = stars, label = percent)) + 
    geom_point(aes(size = percentWeight * 0.8, colour = stars, alpha = 0.05)) + 
    geom_text(hjust = 0.4, size = 4) + scale_size(range = c(1, 30), guide = "none") + 
    scale_color_gradient(low = "darkblue", high = "red") + labs(title = "A grid of detailed avg.ratings by category ", 
    x = "Category", y = "Detailed Avg.Ratings") + scale_y_continuous(breaks = seq(1, 
    5, 0.5)) + theme(legend.title = element_blank())

```

```{r}
city <- final.dat %>% 
  group_by(city) %>% 
  summarise(totalCity = n()) %>% 
  top_n(10)
dataWeighted_city <- left_join(city, final.dat) %>% 
  group_by(city,stars) %>%
  summarise(totalByStar = n()) %>% arrange(desc(stars)) %>% 
  mutate(total = sum(totalByStar)) %>% mutate(percent = round((totalByStar / total)*100, 1)) %>%
  mutate(percentWeight = ifelse(percent >= 20, percent * 1.5, # custom column to weight the percent for size on the plot
                                ifelse(percent < 20 & percent >= 15, percent * 1, 
                                       ifelse(percent < 15 & percent >= 10, percent,
                                              ifelse(percent < 10 & percent >= 5, percent * 0.6, 1)))))


ggplot(dataWeighted_city, aes(x = city, y = stars, label = percent)) + 
    geom_point(aes(size = percentWeight * 0.8, colour = stars, alpha = 0.05)) + 
    geom_text(hjust = 0.4, size = 4) + scale_size(range = c(1, 30), guide = "none") + 
    scale_color_gradient(low = "blue", high = "green") + labs(title = "A grid of detailed avg.ratings by city ", 
    x = "City", y = "Detailed Avg.Ratings") + scale_y_continuous(breaks = seq(1, 
    5, 0.5)) + theme(legend.title = element_blank())
```

## explore words

```{r}
review <- read_csv("../data/review_sample.csv") %>% 
  clean_names() %>% 
  select(business_id, everything()) %>% 
  nest(x1:cool)

businessId = business.dat %>%
  mutate(categories = as.character(categories)) %>%
  filter(str_detect(categories, "Restaurants")) %>% 
  select(business_id)
review_business = inner_join(businessId, review, by  = "business_id") %>% 
  unnest()

```

